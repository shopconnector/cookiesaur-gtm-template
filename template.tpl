___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "categories": [
    "TAG_MANAGEMENT",
    "PERSONALIZATION"
  ],
  "type": "TAG",
  "id": "gdpr_cookie_manager",
  "version": 1,
  "securityGroups": [],
  "displayName": "GDPR cookie manager",
  "brand": {
    "id": "GDPRcookiemanager",
    "displayName": "GDPR cookie manager",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "GDPR cookie manager Â· See more at https://gdprcookiemanager.com/",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "GDPRCookieID",
    "displayName": "Domain Group ID",
    "simpleValueType": true,
    "help": "Create an account on gdprcookiemanager.com and copy \u0027Domain Group ID\u0027 from the panel.",
    "valueHint": "Your GDPR cookie Domain Group ID",
    "notSetText": "Please enter the \u0027Domain Group ID\u0027 in the format \u0027xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\u0027"
  },
  {
    "type": "CHECKBOX",
    "name": "consentModeEnabled",
    "checkboxText": "Enable Google Consent Mode",
    "simpleValueType": true,
    "help": "Enable Consent Mode if one or more of your tags rely on Google\u0027s consent API. Cookie manager will then automatically signal the user\u0027s consent to these tags.",
    "defaultValue": true,
    "alwaysInSummary": true
  },
  {
    "type": "GROUP",
    "name": "ConsentModeSettings",
    "displayName": "Consent Mode Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "GROUP",
        "name": "DefaultConsent",
        "displayName": "Default Consent State",
        "subParams": [
          {
            "type": "PARAM_TABLE",
            "name": "regionSettings",
            "paramTableColumns": [
              {
                "param": {
                  "type": "TEXT",
                  "name": "region",
                  "displayName": "Region (leave blank to apply globally)",
                  "simpleValueType": true
                },
                "isUnique": true
              },
              {
                "param": {
                  "type": "SELECT",
                  "name": "defaultConsentSecurity",
                  "displayName": "Security (security_storage)",
                  "selectItems": [
                    {
                      "value": "denied",
                      "displayValue": "Denied"
                    },
                    {
                      "value": "granted",
                      "displayValue": "Granted"
                    }
                  ],
                  "simpleValueType": true,
                  "help": "Select default consent state for security cookies",
                  "defaultValue": "denied"
                },
                "isUnique": false
              },
              {
                "param": {
                  "type": "SELECT",
                  "name": "defaultConsentStatistics",
                  "displayName": "Statistics (analytics_storage)",
                  "selectItems": [
                    {
                      "value": "denied",
                      "displayValue": "Denied"
                    },
                    {
                      "value": "granted",
                      "displayValue": "Granted"
                    }
                  ],
                  "simpleValueType": true,
                  "defaultValue": "denied",
                  "help": "Select default consent state for statistics cookies"
                },
                "isUnique": false
              },
              {
                "param": {
                  "type": "SELECT",
                  "name": "defaultConsentMarketing",
                  "displayName": "Marketing (ad_storage)",
                  "selectItems": [
                    {
                      "value": "denied",
                      "displayValue": "Denied"
                    },
                    {
                      "value": "granted",
                      "displayValue": "Granted"
                    }
                  ],
                  "simpleValueType": true,
                  "defaultValue": "denied",
                  "help": "Select default consent state for marketing cookies"
                },
                "isUnique": false
              },
              {
                "param": {
                  "type": "SELECT",
                  "name": "defaultConsentPersonalization",
                  "displayName": "Personalization (personalization_storage)",
                  "selectItems": [
                    {
                      "value": "denied",
                      "displayValue": "Denied"
                    },
                    {
                      "value": "granted",
                      "displayValue": "Granted"
                    }
                  ],
                  "simpleValueType": true,
                  "defaultValue": "denied",
                  "help": "Select default consent state for personalization cookies"
                },
                "isUnique": false
              }
            ],
            "newRowButtonText": "Add region",
            "editRowTitle": "Edit region",
            "newRowTitle": "Add region"
          }
        ],
        "help": "A default consent state of \u0027denied\u0027 will apply until the user has submitted a consent. You can add different default states for users in different geographical regions. Please use ISO-3166-1 alpha-2 country codes for region values."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "consentModeEnabled",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const createArgumentsQueue = require('createArgumentsQueue');
const queryPermission = require('queryPermission');
const getCookieValues = require('getCookieValues');
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const callInWindow = require('callInWindow');

const JSON = require('JSON');
const Object = require('Object');

const consentModeEnabled = data.consentModeEnabled;
const regionSettings = data.regionSettings || [];

let hasDefaultState = false;
let hasCookie = false;

log('template data =', data);

// create gtag wrapper
const gtag = createArgumentsQueue('gtag', 'dataLayer');

// create temporary wrapper
const temporaryWrapper = (function() {
  const events = [];
  
  return {
    on: function (event, callback, scope) {
      events.push([event, callback, scope || null]);
      
      return function () {};
    },
    getEvents: function () {
      return events;
    }
  };
})();

setInWindow('CookieConsentWrapper', temporaryWrapper, false);

// get consent cookie
let consentCookie = getCookieValues('gdpr-cookies')[0] || null;

if (consentCookie !== null) {
    hasCookie = true;
    consentCookie = JSON.parse(consentCookie);
    consentCookie = consentCookie.hasOwnProperty('level') && consentCookie.level.length ? consentCookie.level : [];
}

// build storage pool and event triggers
const storagePool = {};
const eventTriggers = {};
const storageNames = ['functionality_storage', 'security_storage', 'personalization_storage', 'ad_storage', 'analytics_storage'];

for (let key in storageNames) {
  const storageName = storageNames[key];
  const eventTriggerName = storageName;
  
  // build storage
  const storage = { name: storageName };
  
  // add storage to pool
  storagePool[storage.name] = storage;
  
  // build event trigger
  if (eventTriggerName && eventTriggerName.trim() !== '') {
    if (eventTriggers.hasOwnProperty(eventTriggerName)) {
      eventTriggers[eventTriggerName].storage_names.push(storage.name);
    } else {
      eventTriggers[eventTriggerName] = {
        name: eventTriggerName,
        storage_names: [storage.name],
        type: 'or'
      };
    }
  }
}

const defaultConsents = {};
const acceptedStorageNames = [];

// setup default consent state
for (let key in storagePool) {
  const storage = storagePool[key];

  let defaultStorageConsent = (null !== consentCookie && -1 !== consentCookie.indexOf(storage.name)) || storage.name === 'functionality_storage' ? 'granted' : 'denied';
  defaultConsents[storage.name] = defaultStorageConsent;
  
  if ('granted' === defaultStorageConsent) {
    acceptedStorageNames.push(storage.name);
  }
}

if (consentModeEnabled !== false) {
  const getSelectedRegionList = (regionValue) => regionValue.split(',').map(region => region.trim()).filter(region => region.length !== 0);
  // Get default consent state per region
  const getConsentRegionData = (regionObject) => {
    
      const consentRegionObject = {
          ad_storage: regionObject.defaultConsentMarketing,
          analytics_storage: regionObject.defaultConsentStatistics,
          functionality_storage: 'granted',
          personalization_storage: regionObject.defaultConsentPersonalization,
          security_storage: regionObject.defaultConsentSecurity
      };
    
      const selectedRegionArr = getSelectedRegionList(regionObject.region);
    
      if (selectedRegionArr.length) {
        consentRegionObject.region = selectedRegionArr;
      }
      
      return consentRegionObject;
  };

  // Set default settings for each region
  regionSettings.forEach(regionObj => {
      const consentRegionObject = getConsentRegionData(regionObj);

      if (!hasCookie) {
        setDefaultConsentState(consentRegionObject);
      } else {
        updateConsentState(defaultConsents);
        gtag('event', 'cookie_consent_update', {});
      }

      if (regionObj.region.trim() === '' || regionObj.region === undefined) {
        hasDefaultState = true;
      }
  });
}

// setup consents without region
if(!hasDefaultState)
  {
    if (!hasCookie) {
      setDefaultConsentState(defaultConsents);
    } else {
      updateConsentState(defaultConsents);
      gtag('event', 'cookie_consent_update', {});
    }
  }

// fire triggers for accepted consents
for (let eventTriggerKey in eventTriggers) {
  const eventTrigger = eventTriggers[eventTriggerKey];
  let invoke = false;

  // check if the trigger should be fired
  for (let storageKey in eventTrigger.storage_names) {
    invoke = -1 !== acceptedStorageNames.indexOf(eventTrigger.storage_names[storageKey]);

    if ((invoke && 'or' === eventTrigger.type) || (!invoke && 'and' === eventTrigger.type)) {
      break;
    }
  }

  // fire the trigger
  if (invoke) {
    gtag('event', eventTrigger.name, {});
    Object.delete(eventTriggers, eventTriggerKey);
    
    log('EventTrigger "' + eventTrigger.name + '" invoked with the default consent.');
  }
}

// setup api enpoint
setInWindow('cc_api_endpoint', 'https://cdn2.gdprcookiemanager.com/api/cookiewidget/cookies/' + data.GDPRCookieID, true);


// inject cookie consent script
const cookieConsentScript = 'https://cdn2.gdprcookiemanager.com/static/cookie-consent.min.js';

if (queryPermission('inject_script', cookieConsentScript)) {
    injectScript(cookieConsentScript, function () {
      const events = temporaryWrapper.getEvents();
      let event;
      let eventKey;
      
      for (eventKey in events) {
        event = events[eventKey];
        callInWindow('CookieConsentWrapper.on', event[0], event[1], event[2]);
      }
      
      data.gtmOnSuccess();
    }, data.gtmOnFailure);
} else {
  data.gtmOnFailure();
}

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn2.gdprcookiemanager.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "cc_api_endpoint"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "CookieConsentWrapper"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "CookieConsentWrapper.on"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "MyCookieConsentWrapper"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: ''


___NOTES___

Created on 10. 09. 2023 0:22:20


